<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actualizar Detalles de Cabaña</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="css/admin-styles.css" rel="stylesheet">
    <style>
        /* Estilos específicos para cabañas */
        .form-container {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }
        
        .cabana-icon {
            color: #27ae60;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-tree"></i>
                    <span>Cabañas Admin</span>
                </div>
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="dashboard.html" class="nav-link">
                            <i class="fas fa-chart-pie"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="cabanas-admin.html" class="nav-link">
                            <i class="fas fa-tree"></i>
                            <span>Mis Cabañas</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="actualizar-detalles-cabana.html" class="nav-link active">
                            <i class="fas fa-edit"></i>
                            <span>Actualizar Detalles</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="crear-anuncio.html?tipo=cabana" class="nav-link">
                            <i class="fas fa-plus"></i>
                            <span>Nueva Cabaña</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-toggle" id="mobileMenuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1 class="page-title">Actualizar Detalles de Cabaña</h1>
                        <div class="breadcrumb">
                            <a href="dashboard.html">Dashboard</a>
                            <i class="fas fa-chevron-right"></i>
                            <span>Actualizar Detalles</span>
                        </div>
                    </div>
                </div>
                
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        <span>AD</span>
                    </div>
                    <div class="user-details">
                        <span class="user-name" id="userName">Administrator</span>
                        <span class="user-role" id="userRole">Admin</span>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div class="message success-message" id="successMessage">
                <i class="fas fa-check-circle"></i>
                <span id="successText">¡Cabaña actualizada exitosamente!</span>
            </div>

            <div class="message error-message" id="errorMessage">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="errorText">Error al actualizar la cabaña</span>
            </div>

            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loadingOverlay">
                <div class="loading-content">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div>Cargando información de la cabaña...</div>
                </div>
            </div>

            <!-- Form Container -->
            <div class="form-container active" id="formContainer">
                <div class="form-header">
                    <h2>
                        <i class="fas fa-tree cabana-icon"></i>
                        Actualizar Información de la Cabaña
                    </h2>
                    <p>Modifica los detalles de tu cabaña para mantener la información actualizada</p>
                </div>

                <div class="form-body">
                    <form id="updateForm">
                        <!-- Información Básica -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-info-circle"></i>
                                Información Básica
                            </h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        Nombre de la Cabaña <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="nombre" name="nombre" required>
                                    <span class="form-hint">Nombre de tu cabaña</span>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label class="form-label">
                                        Descripción <span class="required">*</span>
                                    </label>
                                    <textarea class="form-control" id="descripcion" name="descripcion" rows="4" required></textarea>
                                    <span class="form-hint">Describe tu cabaña y sus características especiales</span>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        Precio por Noche <span class="required">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-prefix">$</span>
                                        <input type="number" class="form-control" id="precio" name="precio" min="0" step="0.01" required>
                                    </div>
                                    <span class="form-hint">Precio en pesos mexicanos</span>
                                </div>
                            </div>
                        </div>

                        <!-- Capacidad -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-users"></i>
                                Capacidad y Características
                            </h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        Máximo de Huéspedes <span class="required">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="huespedes" name="huespedes" min="1" required>
                                    <span class="form-hint">Número máximo de personas</span>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        Número de Habitaciones <span class="required">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="habitaciones" name="habitaciones" min="1" required>
                                    <span class="form-hint">Habitaciones disponibles</span>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        Número de Camas
                                    </label>
                                    <input type="number" class="form-control" id="camas" name="camas" min="1">
                                    <span class="form-hint">Total de camas disponibles</span>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        Metros Cuadrados
                                    </label>
                                    <input type="number" class="form-control" id="metrosCuadrados" name="metrosCuadrados" min="1">
                                    <span class="form-hint">Área total de la cabaña</span>
                                </div>
                            </div>
                        </div>

                        <!-- Ubicación -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-map-marker-alt"></i>
                                Ubicación
                            </h3>
                            
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label class="form-label">
                                        Dirección Completa <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="direccion" name="direccion" required>
                                    <span class="form-hint">Dirección exacta de la cabaña</span>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        Ciudad <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="ciudad" name="ciudad" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        Estado <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="estado" name="estado" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        Código Postal
                                    </label>
                                    <input type="text" class="form-control" id="codigoPostal" name="codigoPostal">
                                </div>
                            </div>
                        </div>

                        <!-- Contacto -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-phone"></i>
                                Información de Contacto
                            </h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        Teléfono <span class="required">*</span>
                                    </label>
                                    <input type="tel" class="form-control" id="telefono" name="telefono" required>
                                    <span class="form-hint">Número de contacto principal</span>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        Email <span class="required">*</span>
                                    </label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                    <span class="form-hint">Correo electrónico de contacto</span>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        Sitio Web
                                    </label>
                                    <input type="url" class="form-control" id="sitioWeb" name="sitioWeb">
                                    <span class="form-hint">URL de tu sitio web (opcional)</span>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">
                                        Horario de Atención
                                    </label>
                                    <input type="text" class="form-control" id="horario" name="horario">
                                    <span class="form-hint">Ej: 9:00 AM - 6:00 PM</span>
                                </div>
                            </div>
                        </div>

                        <!-- Servicios -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-concierge-bell"></i>
                                Servicios Disponibles
                            </h3>
                            
                            <div class="services-grid">
                                <div class="service-item" data-service="wifi">
                                    <input type="checkbox" id="wifi" name="servicios" value="wifi">
                                    <label for="wifi">
                                        <i class="fas fa-wifi"></i>
                                        <span>WiFi Gratuito</span>
                                    </label>
                                </div>
                                
                                <div class="service-item" data-service="estacionamiento">
                                    <input type="checkbox" id="estacionamiento" name="servicios" value="estacionamiento">
                                    <label for="estacionamiento">
                                        <i class="fas fa-parking"></i>
                                        <span>Estacionamiento</span>
                                    </label>
                                </div>
                                
                                <div class="service-item" data-service="cocina">
                                    <input type="checkbox" id="cocina" name="servicios" value="cocina">
                                    <label for="cocina">
                                        <i class="fas fa-utensils"></i>
                                        <span>Cocina Equipada</span>
                                    </label>
                                </div>
                                
                                <div class="service-item" data-service="asador">
                                    <input type="checkbox" id="asador" name="servicios" value="asador">
                                    <label for="asador">
                                        <i class="fas fa-fire"></i>
                                        <span>Asador/BBQ</span>
                                    </label>
                                </div>
                                
                                <div class="service-item" data-service="jacuzzi">
                                    <input type="checkbox" id="jacuzzi" name="servicios" value="jacuzzi">
                                    <label for="jacuzzi">
                                        <i class="fas fa-hot-tub"></i>
                                        <span>Jacuzzi</span>
                                    </label>
                                </div>
                                
                                <div class="service-item" data-service="chimenea">
                                    <input type="checkbox" id="chimenea" name="servicios" value="chimenea">
                                    <label for="chimenea">
                                        <i class="fas fa-fire-alt"></i>
                                        <span>Chimenea</span>
                                    </label>
                                </div>
                                
                                <div class="service-item" data-service="jardin">
                                    <input type="checkbox" id="jardin" name="servicios" value="jardin">
                                    <label for="jardin">
                                        <i class="fas fa-seedling"></i>
                                        <span>Jardín</span>
                                    </label>
                                </div>
                                
                                <div class="service-item" data-service="terraza">
                                    <input type="checkbox" id="terraza" name="servicios" value="terraza">
                                    <label for="terraza">
                                        <i class="fas fa-building"></i>
                                        <span>Terraza</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Características Ecológicas -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-leaf"></i>
                                Características Ecológicas
                            </h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="esEcologico" name="esEcologico" value="true">
                                        <label for="esEcologico">
                                            <i class="fas fa-check"></i>
                                            <span>Esta cabaña es ecológica</span>
                                        </label>
                                    </div>
                                    <span class="form-hint">Marca si tu cabaña implementa prácticas sustentables</span>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de Acción -->
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Actualizar Cabaña
                            </button>
                            
                            <a href="cabanas-admin.html" class="btn btn-secondary">
                                <i class="fas fa-times"></i>
                                Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Overlay para móviles -->
    <div class="overlay" id="overlay"></div>

    <script src="js/auth.js"></script>
    <script>
        const baseURL = 'http://localhost:5000/api';
        const authToken = localStorage.getItem('authToken');
        let cabanaId = null;

        // Verificar autenticación
        if (!authToken) {
            window.location.href = 'login.html';
            throw new Error('No autorizado');
        }

        // Elementos del DOM
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const updateForm = document.getElementById('updateForm');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            loadUserCabana();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Mobile menu
            mobileMenuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });

            sidebarClose.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });

            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });

            // Form submission
            updateForm.addEventListener('submit', handleFormSubmit);

            // Service selection
            setupServiceSelection();
        }

        function setupServiceSelection() {
            document.querySelectorAll('.service-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const label = item.querySelector('label');

                label.addEventListener('click', (e) => {
                    e.preventDefault();
                    checkbox.checked = !checkbox.checked;
                    item.classList.toggle('selected', checkbox.checked);
                });

                checkbox.addEventListener('change', () => {
                    item.classList.toggle('selected', checkbox.checked);
                });
            });
        }

        async function loadUserData() {
            try {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                
                if (userData.nombre) {
                    document.getElementById('userName').textContent = userData.nombre;
                    document.getElementById('userRole').textContent = 
                        userData.role === 'admin' ? 'Administrador' : 'Usuario';
                    
                    const initials = userData.nombre.split(' ')
                        .map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    document.getElementById('userAvatar').innerHTML = `<span>${initials}</span>`;
                }
            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
            }
        }

        async function loadUserCabana() {
            try {
                showLoading();
                
                const response = await fetch(`${baseURL}/cabanas/mis-cabanas`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success' && data.data.cabanas.length > 0) {
                    const cabana = data.data.cabanas[0];
                    cabanaId = cabana._id;
                    await loadCabanaDetails(cabanaId);
                } else {
                    showError('No tienes ninguna cabaña registrada');
                    setTimeout(() => {
                        window.location.href = 'crear-anuncio.html?tipo=cabana';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error cargando cabaña:', error);
                showError('Error al cargar tu cabaña');
            } finally {
                hideLoading();
            }
        }

        async function loadCabanaDetails(cabanaId) {
            try {
                const response = await fetch(`${baseURL}/cabanas/${cabanaId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const cabana = data.data.cabana;
                    populateForm(cabana);
                } else {
                    throw new Error(data.message || 'Error al cargar detalles de la cabaña');
                }
            } catch (error) {
                console.error('Error:', error);
                showError(error.message || 'Error al cargar detalles de la cabaña');
            }
        }

        function populateForm(cabana) {
            // Información básica
            document.getElementById('nombre').value = cabana.nombre || '';
            document.getElementById('descripcion').value = cabana.descripcion || '';
            document.getElementById('precio').value = cabana.precio || '';
            
            // Capacidad
            if (cabana.capacidad) {
                document.getElementById('huespedes').value = cabana.capacidad.huespedes || cabana.capacidad.personasMax || '';
                document.getElementById('habitaciones').value = cabana.capacidad.habitaciones || '';
                document.getElementById('camas').value = cabana.capacidad.camas || '';
            }
            
            // Características específicas de cabañas
            if (cabana.caracteristicas) {
                document.getElementById('metrosCuadrados').value = cabana.caracteristicas.metrosCuadrados || '';
            }
            
            // Ubicación
            if (cabana.ubicacion) {
                document.getElementById('direccion').value = cabana.ubicacion.direccion || '';
                document.getElementById('ciudad').value = cabana.ubicacion.ciudad || '';
                document.getElementById('estado').value = cabana.ubicacion.estado || '';
                document.getElementById('codigoPostal').value = cabana.ubicacion.codigoPostal || '';
            }
            
            // Contacto
            if (cabana.contacto) {
                document.getElementById('telefono').value = cabana.contacto.telefono || '';
                document.getElementById('email').value = cabana.contacto.email || '';
                document.getElementById('sitioWeb').value = cabana.contacto.sitioWeb || '';
                document.getElementById('horario').value = cabana.contacto.horario || '';
            }
            
            // Servicios
            if (cabana.servicios && Array.isArray(cabana.servicios)) {
                cabana.servicios.forEach(servicio => {
                    const checkbox = document.getElementById(servicio);
                    const serviceItem = document.querySelector(`[data-service="${servicio}"]`);
                    
                    if (checkbox && serviceItem) {
                        checkbox.checked = true;
                        serviceItem.classList.add('selected');
                    }
                });
            }
            
            // Características ecológicas
            if (cabana.esEcologico) {
                document.getElementById('esEcologico').checked = true;
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            try {
                showLoading();
                
                const formData = new FormData(updateForm);
                
                // Recopilar servicios seleccionados
                const servicios = [];
                document.querySelectorAll('input[name="servicios"]:checked').forEach(checkbox => {
                    servicios.push(checkbox.value);
                });
                
                // Preparar datos para envío
                const updateData = {
                    // Información básica
                    nombre: formData.get('nombre'),
                    descripcion: formData.get('descripcion'),
                    precio: parseFloat(formData.get('precio')),
                    
                    // Capacidad
                    capacidad: {
                        huespedes: parseInt(formData.get('huespedes')),
                        personasMax: parseInt(formData.get('huespedes')), // Compatibilidad
                        habitaciones: parseInt(formData.get('habitaciones')),
                        camas: parseInt(formData.get('camas') || 0)
                    },
                    
                    // Características específicas de cabañas
                    caracteristicas: {
                        metrosCuadrados: parseInt(formData.get('metrosCuadrados') || 0)
                    },
                    
                    // Ubicación
                    ubicacion: {
                        direccion: formData.get('direccion'),
                        ciudad: formData.get('ciudad'),
                        estado: formData.get('estado'),
                        codigoPostal: formData.get('codigoPostal')
                    },
                    
                    // Contacto
                    contacto: {
                        telefono: formData.get('telefono'),
                        email: formData.get('email'),
                        sitioWeb: formData.get('sitioWeb'),
                        horario: formData.get('horario')
                    },
                    
                    // Servicios
                    servicios: servicios,
                    
                    // Ecológico
                    esEcologico: formData.get('esEcologico') === 'true'
                };
                
                console.log('Datos a enviar:', updateData);
                
                // Enviar actualización
                const response = await fetch(`${baseURL}/cabanas/editar/${cabanaId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showSuccess('¡Cabaña actualizada exitosamente!');
                    
                    // Actualizar datos en localStorage si es necesario
                    setTimeout(() => {
                        window.location.href = 'cabanas-admin.html';
                    }, 2000);
                } else {
                    throw new Error(data.message || 'Error al actualizar la cabaña');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showError(error.message || 'Error al actualizar la cabaña');
            } finally {
                hideLoading();
            }
        }

        // Funciones de UI
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function showSuccess(message) {
            const successText = document.getElementById('successText');
            successText.textContent = message;
            successMessage.style.display = 'flex';
            
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorMessage.style.display = 'flex';
            
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>